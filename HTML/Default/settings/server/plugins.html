[% IF useExtJS; extJsScripts = BLOCK %]
[% descHeight = 65 %]
[% iconSize = 50 %]
<script TYPE="text/javascript">
	var categories = [% categories %];
	var searchData = [% searchData %];
	var category, search;

	Ext.onReady(function() {
		[% PROCESS jsString id='SETUP_EXTENSIONS_WARNING_POPUP' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_WARNING_POPUP2' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_WARNING_POPUP_OTHERREPO' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_ALL' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_HARDWARE', jsId='hardware' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_INFO' jsId='information' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_MISC' jsId='misc' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_MUSICSERVICES' jsId='musicservices' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_PLAYLISTS' jsId='playlists' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_RADIO' jsId='radio' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_SCANNING' jsId='scanning' %]
		[% PROCESS jsString id='SETUP_EXTENSIONS_CATEGORY_TOOLS' jsId='tools' %]

		if (SqueezeJS.UI) {
			Highlight = Ext.extend(SqueezeJS.UI.Highlight, {
				onSelectorClicked : function(ev, target){
					if (target && target.href)
						return;

					var el;
					target = Ext.get(target);

					if (target.dom.href) {
						// don't capture click on link!
					}

					else if (target.dom.htmlFor) {
						target = Ext.get(target.down("input[type=checkbox]"));
						target.dom.checked = !target.dom.checked;
					}

					else if (target.hasClass('thumbwrap') && !target.is('ul.thumbwrap')) {
						target = target.child("input[type=checkbox]");
						target.dom.checked = !target.dom.checked;
					}

					else if (el = target.findParentNode('div.pluginItem', 2, true)) {
						target = el.child("input[type=checkbox]");
						target.dom.checked = !target.dom.checked;
					}
				}
			});

			Highlighter = new Highlight({
				unHighlight : 'content'
			});

			// plugin filtering
			var filterChooser = new SqueezeJS.UI.SplitButton({
				renderTo: 'filterChooser',
				menu: new Ext.menu.Menu({shadow: Ext.isGecko && Ext.isMac ? true : 'sides'}),
				text: SqueezeJS.string('setup_extensions_category_all')
			});

			Ext.each(categories.sort(function(a, b) {
				a = SqueezeJS.string(a || 'setup_extensions_category_all');
				b = SqueezeJS.string(b || 'setup_extensions_category_all');

				if (a < b) return -1
				else if (b < a) return 1
				else return 0;
			}), function(category, x) {
				filterChooser.menu.add(
					new Ext.menu.CheckItem({
						text: category ? SqueezeJS.string(category) : SqueezeJS.string('setup_extensions_category_all'),
						value: category,
						checked: false,
						cls: 'settingsList',
						group: 'settingsList',
						handler: function(ev) {
							category = ev.value;
							filterChooser.setText(category ? SqueezeJS.string(category) : SqueezeJS.string('setup_extensions_category_all')),
							togglePluginVisibility(category, function(s) {
								return s.category == category;
							});
						}
					})
				);
			});

			new Ext.form.TextField({
				applyTo: 'filterInput',
				validationDelay: 100,
				validateOnBlur: false,
				selectOnFocus: true,

				validator: function(value) {
					var reg = new RegExp(value, 'i');

					togglePluginVisibility(value, function(s) {
						return reg.test(s.content);
					});
				}
			});

			var pluginDescriptions = Ext.query('div.pluginDesc');
			Ext.each(pluginDescriptions, function(descEl) {
				descEl = Ext.get(descEl);
				if (descEl.getHeight() > [% descHeight - 5 %]) {
					descEl.addClass('pluginDescLong');
					new Ext.ToolTip({
						target: descEl,
						html: descEl.dom.innerHTML,
						hideDelay: 1500,
						maxWidth: 300
					});
				}
			});

			function togglePluginVisibility(value, validator) {
				var pluginItems = Ext.query('li.thumbwrap');

				if (!value) {
					Ext.each(pluginItems, function(item) {
						Ext.get(item).setDisplayed(true);
					});
				}
				else {
					Ext.each(pluginItems, function(item) {
						var id = item.id.replace('plugin-', '');
						item = Ext.get(item);

						let s = searchData[id];

						if (s && validator(s)) {
							item.setDisplayed(true);
						}
						else {
							item.setDisplayed(false);
						}
					});
				}
			}
		}

		Settings.Page.submit = function(ajax, cb) {
			// display warning if user wants to install "unsafe" plugins from 3rd parties or add the other repo
			var unsafe = Ext.query('input.unsafePlugin');
			var other  = Ext.query('input.otherrepo');
			var msg    = '';

			for (var i = 0; i < unsafe.length; i++) {
				if (unsafe[i].checked)
					msg += '<li>' + unsafe[i].value + '</li>';
			}

			if (msg > '') {
				msg = SqueezeJS.string('plugin_extensions_warning_popup')
						+ '<ul>' + msg + '</ul>'
						+ SqueezeJS.string('plugin_extensions_warning_popup2');
			}

			if (other.length > 0) {
				if (other[0].checked) {
					msg = SqueezeJS.string('plugin_extensions_warning_popup_otherrepo');
				}
			}

			if (msg > '') {
				Ext.Msg.show({
					title: SqueezeJS.string('settings'),
					msg: msg,
					width: 450,
					closable: false,
					buttons: Ext.Msg.OKCANCEL,
					fn: function(btn) {
						if (btn == 'ok') {
							document.forms.settingsForm.submit();
						}
					}
				});
			}

			else {
				document.forms.settingsForm.submit();
			}
		};

		Settings.Page.initCollapsableItems('grid');
	});
</script>
[% END; END %]
<style>
	div.pluginList {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(min(100%, 300px), 1fr));
		gap: 5px;
	}

	ul.thumbWrap {
		display: contents
	}

	.settingSection ul.thumbWrap li.thumbWrap {
		border-radius: 5px;
		border: solid 1px #eee;
		max-width: 370px;
	}

	.pluginItem label {
		font-weight: bold;
		display: block;
	}

	.pluginItem div {
		padding-bottom: 5px;
	}

	.pluginItem label, .pluginDesc, .pluginFooter {
		position: relative;
		padding-left: [% iconSize + 5 %]px;
	}

	.pluginDesc, .pluginFooter {
		max-height: [% descHeight %]px;
		overflow: hidden;
		text-overflow: ellipsis;
		overflow-wrap: break-word;
		word-break: break-word;
	}

	.pluginDescLong:before {
		content: '';
		width: 100%;
		height: 100%;
		position: absolute;
		left: 0;
		top: 0;
		background: linear-gradient(transparent [% descHeight - 30 %]px, white);
	}

	.mouseOver .pluginDescLong:before {
		background: linear-gradient(transparent [% descHeight - 30 %]px, #999);
	}

	.pluginItem img {
		position: absolute;
		margin: 0 5px 5px 0;
		width: [% iconSize %]px;
	}

	#filterChooser {
		width: 200px;
	}

	#pluginButtonBar span {
		vertical-align: top;
	}

	#pluginButtonBar .x-form-text {
		height: 20px;
	}
</style>
[% BLOCK pluginGroup %]
	<div class="settingSection pluginList" id="[% id %]">
		<ul class="thumbwrap">
			[%- content | indent(4) %]
		</ul>
	</div>
[% END %]
[% BLOCK pluginDetails %]
	[% pluginName = type == 'update' ? 'update:' _ plugin.name : plugin.name %]
	<li class="thumbwrap selectorMarker" id="plugin-[% pluginName %]" onmouseover="Highlighter.highlight(this);">
		<div class="thumbwrap">
			<div class="pluginItem">
				<div>
					[% pluginIcon = plugin.icon || "html/images/" _ (plugin.category || "misc") _ ".svg" %]
					[% IF !pluginIcon.match("^http"); pluginIcon = webroot _ pluginIcon; END; %]
					<div>
						<img src="[% pluginIcon | resizeimage(iconSize,iconSize) %]" srcset="[% pluginIcon | resizeimage(iconSize*2,iconSize*2) %] 2x">
						<label for="[% pluginName %]">
							<input name="[% pluginName %]" [% type == 'enabled' && !plugin.error ? "checked=checked" : "" %] type="checkbox" value="[% plugin.title | html %]" [% IF type == 'unsafe' %]class="unsafePlugin"[% END %] />
							&nbsp;[% plugin.title %][% IF plugin.version %] (v[% plugin.version %])[%- END -%]
						</label>
					</div>
					[% IF type != 'update' %]
						<input name="[% IF plugin.manual %]manual[% ELSE %]install[% END %]:[% plugin.name %]" type="hidden" />
					[% END %]
				</div>
				<div>
					<div class="pluginDesc">
						[% ((plugin.error && "<b>" _ plugin.error _ "</b>") || (type == 'update' && plugin.changes) || plugin.desc) | html_line_break %]
					</div>
				</div>
				<div class="pluginFooter">
					[% IF plugin.email %]<a href="mailto:[% plugin.email %]">[% ELSIF plugin.homepage %]<a href="[% plugin.homepage %]" target="_blank">[%- END -%][% plugin.creator || plugin.email %][% IF plugin.email OR plugin.homepage %]</a>[%- END -%]
					[% IF plugin.settings %]<a href="[% webroot %][% plugin.settings %]">[% "SETTINGS" | string %]</a>
					[% ELSIF plugin.link %]<a href="[% plugin.link %]" target="plugin_desc">[% "MOREINFO" | string %]</a>[%- END -%]
				</div>
			</div>
		</div>
	</li>
[% END %]
[% customButtonBar = BLOCK %]
	<div id="pluginButtonBar">
		<span id="filterChooser"></span>
		<span>[% "SEARCH" | string %][% "COLON" | string %] <input type="text" id="filterInput"></span>
	</div>
[% END %]
[% PROCESS settings/header.html %]
	<div class="settingsSmallIndention">
	[% IF updates.size > 0 %]

		[% WRAPPER settingSection %]
			<div class="prefHead collapsableSection" id="updatePlugins_Header"><img class="disclosure_repos"
				src="[% webroot %]html/images/spacer.gif"/>[% "SETUP_EXTENSIONS_UPDATES" | getstring %]</div>
		[%- END -%]

		[% WRAPPER pluginGroup id="updatePlugins" %]
			[% FOREACH plugin = updates.sort('title') %]
				[% PROCESS pluginDetails type = 'update' %]
			[% END %]
		[%- END -%]

	[% END %]

	[% WRAPPER settingSection %]
		<div class="prefHead collapsableSection" id="activePlugins_Header"><img class="disclosure_repos"
			src="[% webroot %]html/images/spacer.gif"/>[% "SETUP_EXTENSIONS_ACTIVE" | getstring %]</div>
	[%- END -%]

	[% WRAPPER pluginGroup id="activePlugins" %]
		[% FOREACH plugin = active.sort('title') %]
			[% PROCESS pluginDetails type = 'enabled' %]
		[% END %]
	[%- END -%]

	[% WRAPPER settingSection %]
		<div class="prefHead collapsableSection" id="inactivePlugins_Header"><img class="disclosure_repos"
			src="[% webroot %]html/images/spacer.gif"/>[% "SETUP_EXTENSIONS_INACTIVE" | getstring %]</div>
	[%- END -%]

	[% WRAPPER pluginGroup id="inactivePlugins" %]
		[% FOREACH plugin = inactive.sort('title') %]
			[% PROCESS pluginDetails type = 'disabled' %]
		[% END %]
	[%- END -%]


	[% FOREACH repo = avail %]

		[% WRAPPER settingSection %]
			<div class="prefHead collapsableSection" id="otherPlugins[% loop.index %]_Header"><img class="disclosure_repos"
				src="[% webroot %]html/images/spacer.gif"/>[% repo.title %]</div>
		[%- END -%]

		[% WRAPPER pluginGroup id="otherPlugins" _ loop.index %]
			[% FOREACH plugin = repo.entries.sort('title') %]
				[% PROCESS pluginDetails type = (repo.weight == 1 ? 'safe' : 'unsafe') %]
			[% END %]
		[%- END -%]

	[%- END -%]
	</div>

	[% WRAPPER setting title="SETUP_EXTENSIONS_AUTO" desc="SETUP_EXTENSIONS_AUTO_DESC" %]
		<input type="checkbox" name="auto" id="auto" [% IF auto %] checked="1" [% END %] />
	[% END %]

	[% WRAPPER setting title="SETUP_EXTENSIONS_REPOS" desc="" %]
		<div>[% "SETUP_EXTENSIONS_REPOS_DESC" | string %]</div>
		<div>[% "SETUP_EXTENSIONS_REPOS_WARNING" | string %]</div>

		<div>
		[% FOREACH entry = repos %]
			<br/><input type="text" class="stdedit" name="repos" id="repos" value="[% entry | html %]" size="60" />
		[% END %]
		</div>
	[% END %]

	[% WRAPPER setting title="SETUP_EXTENSIONS_USE_UNSUPPORTED" desc="" %]
		<input type="checkbox" name="useUnsupported" id="useUnsupported" [% IF useUnsupported %] checked="1" [% END %] />
		<label for="useUnsupported">[% "SETUP_EXTENSIONS_USE_UNSUPPORTED_DESC" | string %]</label>
	[% END %]

	<input name="rand" type="hidden" value="[% rand | html %]" />

[% PROCESS settings/footer.html %]
